(()=>{var A=(d,t)=>()=>(d&&(t=d(d=0)),t);var ut=(d,t)=>()=>(t||d((t={exports:{}}).exports,t),t.exports);function q(d,t,e=0){let s=d.x,a=d.y,h=d.sizeX??d.size??0,i=d.sizeY??d.size??0,r=t.x,n=t.y,p=t.sizeX??t.size??0,u=t.sizeY??t.size??0,m=Math.max(0,Math.min(1,e)),E=h*(1-m),_=i*(1-m),l=p*(1-m),c=u*(1-m),S=s+(h-E)/2,k=a+(i-_)/2,N=r+(p-l)/2,Y=n+(u-c)/2;return!(k+_<Y||k>Y+c||S+E<N||S>N+l)}var z=A(()=>{});var b,G=A(()=>{b=class{constructor({game:t,startX:e=0,startY:s=0,startVx:a=0,startVy:h=0,sprite:i,sizeX:r=128,sizeY:n=128}){this.game=t,this.x=e,this.y=s,this.vx=a,this.vy=h,this.sprite=new Image,this.sprite.src=i,this.sizeX=r,this.sizeY=n,this.invertedSprite=!1}update(){this.x+=this.vx,this.y+=this.vy}draw(t){t.save(),this.vx>0?this.inverted=!0:this.vx<0&&(this.inverted=!1),this.inverted?(t.scale(-1,1),t.drawImage(this.sprite,-this.x-this.sizeX,this.y,this.sizeX,this.sizeY)):t.drawImage(this.sprite,this.x,this.y,this.sizeX,this.sizeY),t.restore()}}});var g,C=A(()=>{g={PLAYER:"./assets/entities/scuba2.png",ENEMY:"./assets/entities/submarine_finanza1.png",COLLECTABLE:"./assets/entities/egg.png",FISH:["./assets/collectables/cod_fish.png","./assets/collectables/salmon_fish.png","./assets/collectables/tropical_fish.png","./assets/collectables/egg.png"],BAD:["./assets/collectables/wheat.png","./assets/collectables/milk.png","./assets/collectables/sugar.png"],SIZES:{PLAYER:{width:100,height:50},ENEMY:{width:100,height:45},COLLECTABLE:{width:42,height:42}}}});var w,Q=A(()=>{w={WATER_SURFACE_RATIO:.2,ENEMY_SPAWN_BASE:3e3,ENEMY_SPAWN_VARIANCE:1e3,COLLECTABLE_SPAWN_BASE:3e3,COLLECTABLE_SPAWN_VARIANCE:1500,BAD_COLLECTABLE_SPAWN_BASE:5e3,BAD_COLLECTABLE_SPAWN_VARIANCE:3e3,COLLECTABLE_LIFETIME:5e3,COLLECTABLE_SCORE:10,BAD_COLLECTABLE_PENALTY:15,BAD_COLLECTABLE_DAMAGE:10,DEATH_FADE_DURATION:1500,ENEMY_COLLISION_COMPENETRATION:.2,VERSION:"0.2.4"}});var v,J,j=A(()=>{Q();v={START_X_RATIO:.5,START_Y_RATIO:w.WATER_SURFACE_RATIO+.05,SPEED:5,ACCELERATION_Y:2e4,ACCELERATION_X:15e3,DRAG:2,BUOYANCY:250,MAX_BREATH:100,BREATH_DECAY_DURATION:1e4,BREATH_REFILL_DURATION:1e3,DAMAGE_INVUL_MS:600,DAMAGE_COLLECTABLE_INVUL_MS:250,ENEMY_DAMAGE:50},J=v});var R,rt=A(()=>{z();G();C();j();R=class extends b{constructor({game:t,inputHandler:e}){let s=t.width*(v.START_X_RATIO??.5),a=t.height*(v.START_Y_RATIO??.5);super({game:t,startX:s,startY:a,sprite:g.PLAYER,sizeX:g.SIZES.PLAYER.width,sizeY:g.SIZES.PLAYER.height}),this.inputHandler=e,this.keys=e.keys,this.speed=v.SPEED??5,this.accelerationX=v.ACCELERATION_X,this.accelerationY=v.ACCELERATION_Y,this.drag=v.DRAG??2,this.buoyancy=v.BUOYANCY??100,this.vx=0,this.vy=0,this._lastMoveTime=performance.now(),this._prevKeys={ArrowUp:!1,w:!1,ArrowDown:!1,s:!1,ArrowLeft:!1,a:!1,ArrowRight:!1,d:!1},this.maxBreath=v.MAX_BREATH??100,this.breath=this.maxBreath,this.breathDecayDuration=v.BREATH_DECAY_DURATION??2e4,this.breathDecayRate=this.maxBreath/this.breathDecayDuration,this.breathRefillDuration=v.BREATH_REFILL_DURATION??1e3,this.breathRefillRate=this.maxBreath/this.breathRefillDuration,this._lastBreathTime=null,this._lastDamageTime=0,this._damageInvulMs=v.DAMAGE_INVUL_MS??500,this._lastDamageInvulMs=this._damageInvulMs,this._lastHitFlashTime=0,this._lastHitFlashDuration=0}update(){let t=performance.now(),e=Math.max(0,t-this._lastMoveTime)/1e3;this._lastMoveTime=t;let s=0,a=0,h=(this.keys.ArrowUp||this.keys.w)&&!(this._prevKeys.ArrowUp||this._prevKeys.w),i=(this.keys.ArrowDown||this.keys.s)&&!(this._prevKeys.ArrowDown||this._prevKeys.s),r=(this.keys.ArrowLeft||this.keys.a)&&!(this._prevKeys.ArrowLeft||this._prevKeys.a),n=(this.keys.ArrowRight||this.keys.d)&&!(this._prevKeys.ArrowRight||this._prevKeys.d);h&&(a-=this.accelerationY),i&&(a+=this.accelerationY),r&&(s-=this.accelerationX),n&&(s+=this.accelerationX),this._prevKeys.ArrowUp=this.keys.ArrowUp,this._prevKeys.w=this.keys.w,this._prevKeys.ArrowDown=this.keys.ArrowDown,this._prevKeys.s=this.keys.s,this._prevKeys.ArrowLeft=this.keys.ArrowLeft,this._prevKeys.a=this.keys.a,this._prevKeys.ArrowRight=this.keys.ArrowRight,this._prevKeys.d=this.keys.d,a-=this.buoyancy,this.vx+=s*e,this.vy+=a*e;let p=Math.max(0,1-this.drag*e);this.vx*=p,this.vy*=p;let u=this.x+this.vx*e,m=this.y+this.vy*e,E=u>=0&&u+this.sizeX<=this.game.width,_=m>=0&&m+this.sizeY<=this.game.height;E?this.x=u:(this.x=Math.max(0,Math.min(u,this.game.width-this.sizeX)),this.vx=0),_?this.y=m:(this.y=Math.max(0,Math.min(m,this.game.height-this.sizeY)),this.vy=0);let l=performance.now(),c=this._lastBreathTime?l-this._lastBreathTime:0;this._lastBreathTime=l;let S=l-this._lastDamageTime;this.y<=this.game.waterSurfaceY&&S>=this._lastDamageInvulMs?this.breath=Math.min(this.maxBreath,this.breath+c*this.breathRefillRate):this.breath=Math.max(0,this.breath-c*this.breathDecayRate)}draw(t){super.draw(t);let e=performance.now(),s=e-this._lastDamageTime,a=e-this._lastHitFlashTime;if(s<this._lastDamageInvulMs||a<this._lastHitFlashDuration){let h=s<this._lastDamageInvulMs?s:a,r=Math.sin(h*.01*Math.PI)>0?.6:0;t.save(),t.fillStyle=`rgba(255, 0, 0, ${r})`,t.fillRect(this.x,this.y,this.sizeX,this.sizeY),t.restore()}this.drawBreathBar(t)}drawBreathBar(t){let e=this.sizeX,s=8,a=this.x,h=this.y-s-8;t.save(),t.fillStyle="#444",t.fillRect(a-1,h-1,e+2,s+2),t.fillStyle="#222",t.fillRect(a,h,e,s);let i=Math.max(0,Math.min(1,this.breath/this.maxBreath)),r=Math.round(e*i),n=Math.round(255*(1-i)),p=Math.round(200*i+55*(1-i));t.fillStyle=`rgb(${n}, 60, ${p})`,t.fillRect(a,h,r,s),t.restore()}takeDamage(t,e){let s=performance.now();return s-this._lastDamageTime<this._lastDamageInvulMs?!1:(this._lastDamageTime=s,this._lastDamageInvulMs=typeof e=="number"?e:this._damageInvulMs,this.breath=Math.max(0,this.breath-t),!0)}flash(t){this._lastHitFlashTime=performance.now(),this._lastHitFlashDuration=typeof t=="number"?t:this._damageInvulMs}}});var U,ot=A(()=>{z();G();C();U=class extends b{constructor({game:t,startX:e=0,startY:s=0,startVx:a=5,startVy:h=0,sprite:i=g.ENEMY,sizeX:r=g.SIZES.ENEMY.width,sizeY:n=g.SIZES.ENEMY.height}){super({game:t,startX:e,startY:s,startVx:a,startVy:h,sprite:i,sizeX:r,sizeY:n}),this._offscreen=!1}update(){this.x+=this.vx;let t=this.y+this.vy;t<this.game.waterSurfaceY?(this.y=this.game.waterSurfaceY,this.vy=-this.vy):t+this.sizeY>this.game.height?(this.y=this.game.height-this.sizeY,this.vy=-this.vy):this.y=t,(this.x+this.sizeX<-50||this.x>this.game.width+50)&&(this._offscreen=!0)}}});function ft(){let d=g.FISH||[];if(d.length===0)return g.COLLECTABLE;let t=Math.floor(Math.random()*d.length);return d[t]}var T,tt=A(()=>{G();C();T=class extends b{constructor({game:t,startX:e=0,startY:s=0,sprite:a=null,sizeX:h=g.SIZES.COLLECTABLE.width,sizeY:i=g.SIZES.COLLECTABLE.height,lifetime:r=5e3}){let n=a||ft();super({game:t,startX:e,startY:s,sprite:n,sizeX:h,sizeY:i}),this.lifetime=r,this._spawnTime=performance.now(),this._collected=!1}update(){performance.now()-this._spawnTime>=this.lifetime&&(this._collected=!0)}draw(t){let s=performance.now()-this._spawnTime,h=1-Math.min(1,s/this.lifetime);t.save(),t.globalAlpha=h,super.draw(t),t.restore()}}});function pt(){let d=g.BAD||[];if(d.length===0)return g.COLLECTABLE;let t=Math.floor(Math.random()*d.length);return d[t]}var V,lt=A(()=>{tt();C();V=class extends T{constructor({game:t,startX:e=0,startY:s=0,sprite:a=null,sizeX:h=g.SIZES.COLLECTABLE.width,sizeY:i=g.SIZES.COLLECTABLE.height,lifetime:r=5e3}){let n=a||pt();super({game:t,startX:e,startY:s,sprite:n,sizeX:h,sizeY:i,lifetime:r}),this.isBad=!0}}});var W,ct=A(()=>{W=class{constructor(t=null){this.keys={},this.game=t,this._isEnabled=!1,this._canvas=null,this._keydownHandler=null,this._keyupHandler=null,this._touchStartHandler=null,this._touchEndHandler=null,this._touchMap={}}create(){this._canvas=document.getElementById("game"),this._keydownHandler=t=>this.keys[t.key]=!0,this._keyupHandler=t=>this.keys[t.key]=!1,this._touchStartHandler=t=>{t.preventDefault();let e=this._canvas.getBoundingClientRect(),s=this._canvas.width/e.width,a=this._canvas.height/e.height;for(let h=0;h<t.changedTouches.length;h++){let i=t.changedTouches[h],r=(i.clientX-e.left)*s,n=(i.clientY-e.top)*a;if(this._touchMap[i.identifier]||(this._touchMap[i.identifier]=[]),this.game&&this.game.player){let p=this.game.player.x,u=this.game.player.y,m=r-p,E=n-u,_=Math.atan2(E,m)*(180/Math.PI);_<0&&(_+=360),_>=330||_<30?(this.keys.d=!0,this._touchMap[i.identifier].includes("d")||this._touchMap[i.identifier].push("d")):_>=30&&_<60?["d","s"].forEach(c=>{this.keys[c]=!0,this._touchMap[i.identifier].includes(c)||this._touchMap[i.identifier].push(c)}):_>=60&&_<120?(this.keys.s=!0,this._touchMap[i.identifier].includes("s")||this._touchMap[i.identifier].push("s")):_>=120&&_<150?["s","a"].forEach(c=>{this.keys[c]=!0,this._touchMap[i.identifier].includes(c)||this._touchMap[i.identifier].push(c)}):_>=150&&_<210?(this.keys.a=!0,this._touchMap[i.identifier].includes("a")||this._touchMap[i.identifier].push("a")):_>=210&&_<240?["a","w"].forEach(c=>{this.keys[c]=!0,this._touchMap[i.identifier].includes(c)||this._touchMap[i.identifier].push(c)}):_>=240&&_<300?(this.keys.w=!0,this._touchMap[i.identifier].includes("w")||this._touchMap[i.identifier].push("w")):_>=300&&_<330&&["w","d"].forEach(c=>{this.keys[c]=!0,this._touchMap[i.identifier].includes(c)||this._touchMap[i.identifier].push(c)})}}},this._touchEndHandler=t=>{t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){let s=t.changedTouches[e],a=this._touchMap[s.identifier];a&&(a.forEach(h=>this.keys[h]=!1),delete this._touchMap[s.identifier])}},this._mouseDownHandler=t=>{let e=this._canvas.getBoundingClientRect(),s=t.clientX-e.left,a=t.clientY-e.top,h="mouse";this._touchMap[h]||(this._touchMap[h]=[]);let i=this._canvas.width/e.width,r=this._canvas.height/e.height,n=s*i,p=a*r;if(this.game&&this.game.player){let u=this.game.player.x,m=this.game.player.y,E=n-u,_=p-m,l=Math.atan2(_,E)*(180/Math.PI);l<0&&(l+=360);let c=S=>{this.keys[S]=!0,this._touchMap[h].includes(S)||this._touchMap[h].push(S)};l>=330||l<30?c("d"):l>=30&&l<60?(c("d"),c("s")):l>=60&&l<120?c("s"):l>=120&&l<150?(c("s"),c("a")):l>=150&&l<210?c("a"):l>=210&&l<240?(c("a"),c("w")):l>=240&&l<300?c("w"):l>=300&&l<330&&(c("w"),c("d"))}},this._mouseUpHandler=t=>{let e="mouse",s=this._touchMap[e];s&&(s.forEach(a=>this.keys[a]=!1),delete this._touchMap[e])}}enable(){console.log("Enabling input handler",this._isEnabled),!this._isEnabled&&(this._isEnabled=!0,document.addEventListener("keydown",this._keydownHandler),document.addEventListener("keyup",this._keyupHandler),this._canvas?(this._canvas.addEventListener("touchstart",this._touchStartHandler,{passive:!1}),this._canvas.addEventListener("touchend",this._touchEndHandler,{passive:!1}),this._canvas.addEventListener("touchcancel",this._touchEndHandler,{passive:!1}),this._canvas.addEventListener("mousedown",this._mouseDownHandler),this._canvas.addEventListener("mouseup",this._mouseUpHandler)):(document.addEventListener("touchstart",this._touchStartHandler,{passive:!1}),document.addEventListener("touchend",this._touchEndHandler,{passive:!1}),document.addEventListener("touchcancel",this._touchEndHandler,{passive:!1}),document.addEventListener("mousedown",this._mouseDownHandler),document.addEventListener("mouseup",this._mouseUpHandler)))}disable(){console.log("Disabling input handler",this._isEnabled),this._isEnabled&&(this._isEnabled=!1,document.removeEventListener("keydown",this._keydownHandler),document.removeEventListener("keyup",this._keyupHandler),this._canvas?(this._canvas.removeEventListener("touchstart",this._touchStartHandler),this._canvas.removeEventListener("touchend",this._touchEndHandler),this._canvas.removeEventListener("touchcancel",this._touchEndHandler),this._canvas.removeEventListener("mousedown",this._mouseDownHandler),this._canvas.removeEventListener("mouseup",this._mouseUpHandler)):(document.removeEventListener("touchstart",this._touchStartHandler),document.removeEventListener("touchend",this._touchEndHandler),document.removeEventListener("touchcancel",this._touchEndHandler),document.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mouseup",this._mouseUpHandler)))}}});var K,dt=A(()=>{K=class{constructor(t,e,s){this.ctx=e,this.canvas=t,this.statusImages={normal:new Image,left:new Image,right:new Image,low:new Image,lower:new Image,faint:new Image},this.statusImages.normal.src="./assets/status/davide_normal.png",this.statusImages.left.src="./assets/status/davide_normal_left.png",this.statusImages.right.src="./assets/status/davide_normal_right.png",this.statusImages.low.src="./assets/status/davide_low.png",this.statusImages.lower.src="./assets/status/davide_lower.png",this.statusImages.faint.src="./assets/status/davide_faint.png",this.statusImage=this.statusImages.normal,this._statusState="normal",this._lastStatusTrigger=performance.now(),this._statusAnimActive=!1,this._statusAnimSequence=["left","normal","right"],this._statusAnimFrameIndex=0,this._statusAnimFrameDur=750,this._statusAnimateTime=2500,this._statusNextFrameTime=0,this._player=s}drawStatus(){let r=null;if(this._player){let p=this._player,u=p.maxBreath>0?p.breath/p.maxBreath:1;u<.02?r="faint":u<.25?r="lower":u<.5&&(r="low")}let n=performance.now();r?this.statusImage=this.statusImages[r]||this.statusImages.normal:(!this._statusAnimActive&&n-this._lastStatusTrigger>=this._statusAnimateTime&&(this._statusAnimActive=!0,this._statusAnimFrameIndex=0,this._statusNextFrameTime=n+this._statusAnimFrameDur,this._statusState=this._statusAnimSequence[0]),this._statusAnimActive&&n>=this._statusNextFrameTime&&(this._statusAnimFrameIndex++,this._statusAnimFrameIndex>=this._statusAnimSequence.length?(this._statusAnimActive=!1,this._statusState="normal",this._lastStatusTrigger=n):(this._statusState=this._statusAnimSequence[this._statusAnimFrameIndex],this._statusNextFrameTime=n+this._statusAnimFrameDur)),this.statusImage=this.statusImages[this._statusState]||this.statusImages.normal),this.ctx.save(),this.statusImage&&this.statusImage.complete&&this.ctx.drawImage(this.statusImage,this.canvas.width-192,16,64,64),this.ctx.restore()}reset(t){this._player=t||this._player,this._statusState="normal",this._statusAnimActive=!1,this._statusAnimFrameIndex=0,this._statusNextFrameTime=0,this._lastStatusTrigger=performance.now(),this.statusImage=this.statusImages.normal}}});var Z,mt=A(()=>{rt();ot();tt();lt();ct();dt();z();C();Q();j();Z=class{constructor(t){this.canvas=t,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.input=new W(this),this.input.create(),this.player=new R({game:this,inputHandler:this.input}),this.enemies=[],this.collectables=[],this.entities=[],this.status=new K(this.canvas,this.ctx,this.player),this.score=0,this.finalScore=0,this.isRunning=!1,this.isDead=!1,this._deathFadeStartTime=0,this._deathFadeDuration=w.DEATH_FADE_DURATION??1500,this.waterSurfaceY=this.height*(w.WATER_SURFACE_RATIO??.15),this.spawnIntervalBase=w.ENEMY_SPAWN_BASE??3e3,this.spawnIntervalVariance=w.ENEMY_SPAWN_VARIANCE??1e3,this._nextSpawnTime=performance.now()+this._getNextSpawnDelay(),this.collectableSpawnIntervalBase=w.COLLECTABLE_SPAWN_BASE??3e3,this.collectableSpawnIntervalVariance=w.COLLECTABLE_SPAWN_VARIANCE??1500,this._nextGoodCollectableSpawnTime=performance.now()+this._getNextGoodCollectableSpawnDelay(),this.badCollectableSpawnIntervalBase=w.BAD_COLLECTABLE_SPAWN_BASE??w.COLLECTABLE_SPAWN_BASE??3e3,this.badCollectableSpawnIntervalVariance=w.BAD_COLLECTABLE_SPAWN_VARIANCE??w.COLLECTABLE_SPAWN_VARIANCE??1500,this._nextBadCollectableSpawnTime=performance.now()+this._getNextBadCollectableSpawnDelay(),this.bgImage=new Image,this.bgImage.src="./assets/background/background_new2.png",this.menuOverlay=document.getElementById("menu-overlay")}updatePlayer(){this.player.update(),this.player.y<this.waterSurfaceY&&(this.player.y=this.waterSurfaceY,this.player.vy<0&&(this.player.vy=0))}updateEnemies(){for(let t=this.enemies.length-1;t>=0;t--){let e=this.enemies[t];e.update();let s=w.ENEMY_COLLISION_COMPENETRATION??.1;q(this.player,e,s)&&this.player.takeDamage(J.ENEMY_DAMAGE),e._offscreen&&this.enemies.splice(t,1)}}updateCollectables(){for(let t=this.collectables.length-1;t>=0;t--){let e=this.collectables[t];if(e.update(),q(this.player,e)){if(e.isBad){this.score-=w.BAD_COLLECTABLE_PENALTY??0;let s=w.BAD_COLLECTABLE_DAMAGE,a=J.DAMAGE_COLLECTABLE_INVUL_MS;this.player.takeDamage(s,a),this.player&&typeof this.player.flash=="function"&&this.player.flash(a)}else this.score+=w.COLLECTABLE_SCORE??10;e._collected=!0}e._collected&&this.collectables.splice(t,1)}}update(){if(!this.isRunning)return;if(this.player.breath<=0&&!this.isDead&&(this.isDead=!0,this._deathFadeStartTime=performance.now()),this.isDead&&performance.now()-this._deathFadeStartTime>=this._deathFadeDuration){this.resetToMenu();return}this.updatePlayer(),this.updateEnemies(),this.updateCollectables();let t=performance.now();t>=this._nextSpawnTime&&(this.spawnEnemy(),this._nextSpawnTime=t+this._getNextSpawnDelay()),t>=this._nextGoodCollectableSpawnTime&&(this.spawnCollectable(),this._nextGoodCollectableSpawnTime=t+this._getNextGoodCollectableSpawnDelay()),t>=this._nextBadCollectableSpawnTime&&(this.spawnBadCollectable(),this._nextBadCollectableSpawnTime=t+this._getNextBadCollectableSpawnDelay())}_getNextSpawnDelay(){return this.spawnIntervalBase+(Math.random()*2-1)*this.spawnIntervalVariance}_getNextGoodCollectableSpawnDelay(){return this.collectableSpawnIntervalBase+(Math.random()*2-1)*this.collectableSpawnIntervalVariance}_getNextBadCollectableSpawnDelay(){return this.badCollectableSpawnIntervalBase+(Math.random()*2-1)*this.badCollectableSpawnIntervalVariance}spawnEnemy(){let{width:t,height:e}=g.SIZES.ENEMY,s=Math.random()<.5,a=Math.random()*(this.height-e),h=2+Math.random()*3,i,r;s?(i=-t-10,r=h):(i=this.width+10,r=-h);let n=(Math.random()*2-1)*2,p=new U({game:this,startX:i,startY:a,startVx:r,startVy:n,sizeX:t,sizeY:e});this.enemies.push(p)}spawnCollectable(){let{width:t,height:e}=g.SIZES.COLLECTABLE,s=Math.random()*(this.width-t),a=this.height*.5,h=a+Math.random()*(this.height-a-e),i=w.COLLECTABLE_LIFETIME??5e3,r=new T({game:this,startX:s,startY:h,sizeX:t,sizeY:e,lifetime:i});this.collectables.push(r)}spawnBadCollectable(){let{width:t,height:e}=g.SIZES.COLLECTABLE,s=Math.random()*(this.width-t),a=this.height*.5,h=a+Math.random()*(this.height-a-e),i=w.COLLECTABLE_LIFETIME??5e3,r=new V({game:this,startX:s,startY:h,sizeX:t,sizeY:e,lifetime:i});this.collectables.push(r)}drawPlayer(){this.player.draw(this.ctx)}drawEnemies(){for(let t of this.enemies)t.draw(this.ctx)}drawCollectables(){for(let t of this.collectables)t.draw(this.ctx)}draw(){this.isRunning?(this.drawGame(),this.isDead&&this.drawDeathFade()):this.drawMenu()}drawDeathFade(){let e=performance.now()-this._deathFadeStartTime,a=Math.min(1,e/this._deathFadeDuration);this.ctx.fillStyle=`rgba(0, 0, 0, ${a})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}resetToMenu(){this.finalScore=this.score,this.isRunning=!1,this.isDead=!1,this.score=0,this.enemies=[],this.collectables=[],this.player=new R({game:this,inputHandler:this.input}),this.status.reset(this.player),this._nextSpawnTime=performance.now()+this._getNextSpawnDelay(),this._nextGoodCollectableSpawnTime=performance.now()+this._getNextGoodCollectableSpawnDelay(),this._nextBadCollectableSpawnTime=performance.now()+this._getNextBadCollectableSpawnDelay(),this.input.disable(),this.menuOverlay.classList.remove("hidden");try{document.dispatchEvent(new CustomEvent("game:resetToMenu",{detail:{finalScore:this.finalScore}}))}catch{}}drawGame(){this.ctx.drawImage(this.bgImage,0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="rgba(30, 100, 200, 0.3)",this.ctx.fillRect(0,this.waterSurfaceY,this.canvas.width,this.canvas.height),this.drawPlayer(),this.drawEnemies(),this.drawCollectables(),this.drawScore(),this.drawVersion(),this.status.drawStatus()}drawMenu(){this.ctx.drawImage(this.bgImage,0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.font="bold 48px Arial",this.ctx.fillStyle="#fff",this.ctx.textAlign="center",this.ctx.fillText("SCUBA DAVIDE",this.width/2,this.height/2-80),this.finalScore!==0&&(this.ctx.font="32px Arial",this.ctx.fillStyle="#ffd700",this.ctx.fillText(`Final Score: ${this.finalScore}`,this.width/2,this.height/2-20)),this.ctx.restore(),this.drawVersion()}drawScore(){let e=this.height/10,s=24;this.ctx.save(),this.ctx.font=`bold ${s}px Arial`,this.ctx.fillStyle="#f96705ff",this.ctx.textAlign="right",this.ctx.fillText(`Score: ${this.score}`,this.width-10,e+s/2),this.ctx.restore()}drawVersion(){this.ctx.save(),this.ctx.font="12px Arial",this.ctx.fillStyle="#000000",this.ctx.textAlign="right",this.ctx.textBaseline="bottom",this.ctx.fillText(`Version: ${w.VERSION}`,this.width-10,this.height-10),this.ctx.restore()}loop(){this.isRunning&&this.update(),this.draw(),requestAnimationFrame(this.loop.bind(this))}startGame(){this.isRunning=!0,this.input.enable(),console.log("Hiding menu overlay",this.menuOverlay),this.menuOverlay.classList.add("hidden")}handleCanvasClick(t){if(!this.isRunning&&this._startButtonRect){let e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,a=t.clientY-e.top,h=this.canvas.width/e.width,i=this.canvas.height/e.height,r=s*h,n=a*i,p=this._startButtonRect;r>=p.x&&r<=p.x+p.width&&n>=p.y&&n<=p.y+p.height&&this.startGame()}}}});var _t=ut(()=>{mt();window.addEventListener("DOMContentLoaded",()=>{let d=document.getElementById("game"),t=new Z(d),e="https://script.google.com/macros/s/AKfycbw6Q45Wxl7VrfBESpcHOfIATTI2ecxZrktOR75EPwbQey2OcYZf3_jE8MSMYDGxPoamMA/exec";function s(o,f=20){let F=Math.max(100,window.innerWidth-f*2),M=Math.max(100,window.innerHeight-f*2),L=Math.min(F/800,M/450);o.style.width=800*L+"px",o.style.height=450*L+"px"}window.addEventListener("resize",()=>s(d)),s(d),d.addEventListener("click",o=>{t.handleCanvasClick(o)});let a=document.getElementById("menu-overlay"),h=document.getElementById("btn-start"),i=document.getElementById("btn-tutorial"),r=document.getElementById("btn-scoreboard"),n=document.getElementById("btn-submit"),p=document.getElementById("submit-area"),u=document.getElementById("submit-name"),m=document.getElementById("submit-msg"),E=document.getElementById("menu-panel"),_=E?E.innerHTML:"",l=document.getElementById("btn-credits"),c=null,S="OH! OH! OH! YOU'RE A NAUGHTY BOY!";function k(o){let f=2166136261;for(let y=0;y<o.length;y++)f^=o.charCodeAt(y),f+=(f<<1)+(f<<4)+(f<<7)+(f<<8)+(f<<24);return(f>>>0).toString(16)}h&&h.addEventListener("click",()=>{t.startGame(),x(null),O(),st()});function N(o){p&&(et(),!(!o||o===0)&&(p.classList.remove("hidden"),p.setAttribute("aria-hidden","false"),u&&(u.value="",n&&(n.disabled=!0),u.addEventListener("input",()=>{let f=(u.value||"").trim().length>0;n&&(n.disabled=!f),m&&(m.classList.add("hidden"),m.classList.remove("error"))}))))}function Y(){n?.classList.add("hidden"),n?.setAttribute("aria-hidden","true"),u?.classList.add("hidden"),u?.setAttribute("aria-hidden","true")}function et(){n?.classList.remove("hidden"),n?.setAttribute("aria-hidden","false"),u?.classList.remove("hidden"),u?.setAttribute("aria-hidden","false")}function st(){p&&(p.classList.add("hidden"),p.setAttribute("aria-hidden","true"),u&&(u.value=""),n&&(n.disabled=!0),m&&(m.classList.add("hidden"),m.classList.remove("error"),m.textContent=""))}n&&(n.addEventListener("click",async()=>{try{let o=t.finalScore||0;if(!o||o===0)return;let f=(u?.value||"").trim();if(!f){m&&(m.textContent="Please enter your alias",m.classList.remove("hidden"),m.classList.add("error")),u?.focus();return}let y=document.createElement("span");y.className="spinner",y.style.width="28px",y.style.height="28px",y.style.marginLeft="10px",n.parentNode.insertBefore(y,n.nextSibling),n.disabled=!0,u.disabled=!0;let I=Date.now(),F=`${f}|${o}|${I}|${S}`,M=k(F),L={name:String(f),score:String(o),timestamp:String(I),hash:M};console.log("payload: ",L);let B=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(L).toString()}),D=await B.json();if(console.log("submit response:",D),!B.ok)throw new Error("Failed to submit score");if(D.status!=="ok")throw new Error(S);Y(),m&&(m.textContent="Score Submitted!",m.classList.remove("hidden"),m.classList.remove("error"))}catch(o){console.error("Submit failed",o),m&&(m.textContent=o.message||"Could not submit score.",m.classList.remove("hidden"),m.classList.add("error"))}finally{let o=n.parentNode.querySelector(".spinner");o&&o.remove(),n.disabled=!1,u.disabled=!1}}),u&&u.addEventListener("keydown",o=>{if(o.key==="Enter"){if(!n||n.disabled)return;n.click()}}));function x(o){E&&(c=o,[i,r,l].forEach(f=>{f&&f.classList.remove("active")}),o?.classList?.add("active"))}function O(){E&&E.classList.add("hidden-visibility")}function H(){E&&E.classList.remove("hidden-visibility")}async function it(){if(c===i){x(null),O();return}try{let o=await fetch("./assets/text/tutorial.md");if(!o.ok)throw new Error("Failed to load tutorial");let f=await o.text();E.innerHTML=f,H(),x(i)}catch(o){console.error(o),alert("Could not load tutorial.")}}i&&i.addEventListener("click",it),it(),r&&r.addEventListener("click",async()=>{if(E){if(c===r){x(null),O();return}E.innerHTML='<div class="spinner" aria-label="Loading"></div>',H(),x(r);try{let o=await fetch(e);if(!o.ok)throw new Error("Failed to load scoreboard");let f=await o.json();console.log("scoreboard data:",f);let y=localStorage.getItem("scuba_scores"),I=y?JSON.parse(y):[],F=(f.scores||[]).concat(I||[]),M=f.slice().sort((P,$)=>$.points-P.points),L=document.createElement("table");L.className="scoreboard-table";let B=document.createElement("thead");B.innerHTML="<tr><th>Rank</th><th>Name</th><th>Score</th></tr>";let D=document.createElement("tbody");M.forEach((P,$)=>{let X=document.createElement("tr"),at=document.createElement("td");at.textContent=String($+1);let nt=document.createElement("td");nt.textContent=P.name||"";let ht=document.createElement("td");ht.textContent=String(P.score||0),X.appendChild(at),X.appendChild(nt),X.appendChild(ht),D.appendChild(X)}),L.appendChild(B),L.appendChild(D),E.innerHTML="<h2>Scoreboard</h2>",E.appendChild(L),H(),x(r)}catch(o){console.error(o),E.innerHTML='<h2>Scoreboard</h2><p style="color:#ffb3b3;">Could not load scoreboard.</p>'}}}),document.addEventListener("game:resetToMenu",o=>{let f=o?.detail?.finalScore??0;f?N(f):st()}),l&&l.addEventListener("click",async()=>{if(E){if(c===l){x(null),O();return}try{let o=await fetch("./assets/text/credits.md");if(!o.ok)throw new Error("Failed to load credits");let f=await o.text();console.log("Credits text:",f),E.innerHTML='<h2>Credits</h2><pre style="white-space:pre-wrap; color:#fff;">'+f+"</pre>",H(),x(l)}catch(o){console.error(o),alert("Could not load credits.")}}}),t.loop()})});_t();})();
